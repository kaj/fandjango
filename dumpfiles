#!/usr/bin/env python
# -*- coding: utf-8 -*-
from django.core.management import setup_environ
import settings # Assumed to be in the same directory.
setup_environ(settings)

from libris.models import *
from xml.dom import minidom as dom

def xmlEpisode(doc, pub):
    episode, issue = pub.episode, pub.issue
    elem = doc.createElement
    text = doc.createTextNode
    i = elem('serie')
    if pub.label:
        i.appendChild(elem('label')).appendChild(text(pub.label))
    i.appendChild(elem('title')).appendChild(text(episode.title.title))
    if episode.episode:
        i.appendChild(elem('episode')).appendChild(text(episode.episode))
    if episode.part_no or episode.part_name:
        px = i.appendChild(elem('part'))
        if episode.part_no:
            px.setAttribute('no', unicode(episode.part_no))
        if episode.part_name:
            px.appendChild(text(episode.part_name))
    if episode.teaser:
        i.appendChild(elem('teaser')).appendChild(text(episode.teaser))
    
    if episode.ref_keys.count():
        ref = i.appendChild(elem('ref'))
        for r in episode.ref_keys.all():
            ref.appendChild(elem('key')).appendChild(text(r.title))

    creativeparts = episode.creativepart_set.all()
    for role in ('', 'text', 'bild', 'xlat'):
        by = [unicode(p.alias or p.creator)
              for p in creativeparts.filter(role=role)]
        if by:
            px = i.appendChild(elem('by'))
            if role:
                px.setAttribute('role', role)
            if len(by) == 1:
                px.appendChild(text(by[0]))
            else:
                for b in by[:-1]:
                    px.appendChild(elem('who')).appendChild(text(b))
                    px.appendChild(text(' & '))
                px.appendChild(elem('who')).appendChild(text(by[-1]))
    
    for ppub in episode.publication_set.exclude(issue=issue):
        px = i.appendChild(elem('prevpub'))
        px.appendChild(elem('fa')).appendChild(text(unicode(ppub.issue.number)))
        px.appendChild(elem('year')).appendChild(text(unicode(ppub.issue.year)))
    
    if episode.copyright:
        i.appendChild(elem('copyright')).appendChild(text(episode.copyright))
    return i

def xmlArticle(doc, article):
    elem = doc.createElement
    text = doc.createTextNode
    i = elem('text')
    i.appendChild(elem('title')).appendChild(text(article.title))
    if article.subtitle:
        i.appendChild(elem('subtitle')).appendChild(text(article.subtitle))
    if article.ref_keys.count():
        ref = i.appendChild(elem('ref'))
        for r in article.ref_keys.all():
            ref.appendChild(elem('key')).appendChild(text(r.title))
    return i


year=1983

d=dom.Document()
libris = d.appendChild(d.createElement('libris'))
info = libris.appendChild(d.createElement('info'))
info.appendChild(d.createElement('title')).appendChild(d.createTextNode('Fantomen'))
info.appendChild(d.createElement('year')).appendChild(d.createTextNode(unicode(year)))

for issue in Issue.objects.filter(year=year):
    xmli = libris.appendChild(d.createElement('issue'))
    xmli.setAttribute('nr', str(issue.number))
    if issue.pages:
        xmli.setAttribute('pages', str(issue.pages))
    cover = d.createElement('omslag')
    for creator in issue.cover_by.all():
        cover.appendChild(d.createElement('by')).\
            appendChild(d.createTextNode(creator.name))
    xmli.appendChild(cover)
    for pub in Publication.objects.filter(issue=issue):
        if pub.episode: xmli.appendChild(xmlEpisode(d, pub))
        if pub.article: xmli.appendChild(xmlArticle(d, pub.article))

print d.toxml(encoding='utf-8')
